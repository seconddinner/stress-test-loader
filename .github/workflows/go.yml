name: Go

on:
  push:
    branches: [ "main", build-container, cicd-aws]
  pull_request:
    branches: [ "main", build-container ]

permissions:
  id-token: write
  contents: read

jobs:

  build:
    runs-on: ubuntu-latest
    container: seconddinner/build:0.0.1
    # #container: golang:1.17
    steps:
    - uses: actions/checkout@v3   

    - name: build.sh
      run: cd stress-test-loader; bash ./build.sh

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-region: us-west-2
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        role-session-name: MySessionName

    - name: packer build
      run: |
        cd $GITHUB_WORKSPACE/stress-test-loader
        find .
        source cicd/ami/build-stress-test-loader.sh
  
    - name: terraform test
      run: terraform version

    # - name: terraform init
    #   run: | 
    #     cd $GITHUB_WORKSPACE/infra-terraform/instance/single-region
    #     terraform init
    #     terraform apply  -auto-approve  -input=false